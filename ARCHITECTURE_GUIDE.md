# OKX定投系统架构设计与开发原则

## 系统架构概述

本系统采用**代理转发架构**，解决OKX API的IP白名单限制问题，实现本地开发与线上部署的无缝切换。

### 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        整体架构流程                              │
└─────────────────────────────────────────────────────────────────┘

本地开发环境：
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   本地前端      │───▶│   本地后端      │───▶│  AWS服务器代理  │
│  (Vue.js)      │    │ (FastAPI)      │    │   (FastAPI)    │
│ localhost:5173 │    │ localhost:8000 │    │13.158.74.102   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │                        │
                              ▼                        ▼
                    ┌─────────────────┐    ┌─────────────────┐
                    │ OKXProxyClient │    │   OKXClient    │
                    │   (代理模式)    │    │   (直连模式)    │
                    └─────────────────┘    └─────────────────┘
                                                      │
                                                      ▼
                                           ┌─────────────────┐
                                           │    OKX API     │
                                           │  (需要IP白名单)  │
                                           └─────────────────┘

生产环境：
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端页面      │───▶│  AWS后端服务    │───▶│    OKX API     │
│13.158.74.102   │    │13.158.74.102   │    │  (直连访问)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 核心组件说明

### 1. 线上服务器（AWS - 13.158.74.102:8000）

**职责**：
- 运行完整的FastAPI后端服务
- 存储真实的OKX API密钥配置
- 直连OKX API（IP已加入白名单）
- 为本地开发提供代理转发服务

**关键特性**：
- ✅ 配置了完整的OKX API密钥（api_key, secret_key, passphrase）
- ✅ IP地址已加入OKX白名单，可直接访问OKX API
- ✅ 数据库存储所有业务数据（DCA计划、交易记录、配置等）
- ✅ 提供代理接口 `/api/proxy/okx` 供本地开发使用

### 2. 本地开发环境

**职责**：
- 前端开发和调试
- 后端逻辑开发和测试
- 通过代理访问OKX API

**启动方式**：
```bash
# 后端
cd backend
python3 start_local.py

# 前端
cd frontend
npm run dev
```

**工作原理**：
- 环境变量 `ENVIRONMENT=local` 触发代理模式
- 使用 `OKXProxyClient` 替代 `OKXClient`
- 所有OKX API请求转发到线上服务器

### 3. 环境自动检测

系统会自动检测运行环境：

```python
def detect_environment():
    # 1. 环境变量优先
    env = os.getenv('ENVIRONMENT')
    if env in ['local', 'production']:
        return env
    
    # 2. 自动检测
    hostname = socket.gethostname().lower()
    if 'local' in hostname:
        return 'local'
    
    # 3. IP地址检测
    if is_aws_server_ip() or is_production_ip():
        return 'production'
    
    # 4. 默认本地环境（安全选择）
    return 'local'
```

## 开发原则与约束

### 🚫 绝对禁止的操作

1. **不得随意修改线上服务器核心逻辑**
   - 不得删除或破坏API配置相关功能
   - 不得修改数据库模型结构（除非经过充分测试）
   - 不得删除现有的API端点

2. **不得破坏代理转发机制**
   - 不得删除 `proxy_api.py` 文件
   - 不得修改 `/api/proxy/okx` 端点
   - 不得破坏环境检测逻辑

3. **不得影响线上服务稳定性**
   - 重构前必须充分理解现有架构
   - 大规模修改前必须备份和测试
   - 不得在生产环境直接测试未验证的代码

### ✅ 允许的操作

1. **前端开发**
   - 可以自由修改Vue.js组件
   - 可以添加新的页面和功能
   - 可以优化UI/UX体验

2. **后端功能扩展**
   - 可以添加新的API端点
   - 可以优化现有业务逻辑
   - 可以添加新的数据模型（保持向后兼容）

3. **代码优化**
   - 可以重构代码提高可读性
   - 可以优化性能和错误处理
   - 可以添加日志和监控

### ⚠️ 需要谨慎的操作

1. **数据库相关修改**
   - 修改前必须备份数据
   - 确保向后兼容性
   - 在本地充分测试

2. **API接口修改**
   - 保持接口向后兼容
   - 更新相关文档
   - 通知前端开发者

3. **依赖库更新**
   - 测试兼容性
   - 检查安全漏洞
   - 逐步升级

## 开发工作流

### 本地开发流程

1. **环境准备**
   ```bash
   git pull origin main
   cd backend
   python3 start_local.py  # 自动设置代理模式
   ```

2. **前端开发**
   ```bash
   cd frontend
   npm run dev
   ```

3. **功能开发**
   - 前端连接 `localhost:5173`
   - 后端API `localhost:8000`
   - OKX API请求自动代理到线上服务器

4. **测试验证**
   - 本地功能测试
   - API接口测试
   - 跨浏览器兼容性测试

5. **代码提交**
   ```bash
   git add .
   git commit -m "feat: 描述新功能"
   git push origin main
   ```

### 生产部署流程

1. **代码同步**
   - 线上服务器自动拉取最新代码
   - 或手动执行 `git pull origin main`

2. **服务重启**
   - 重启FastAPI服务
   - 检查服务状态

3. **功能验证**
   - 验证核心功能正常
   - 检查API配置完整
   - 确认数据完整性

## 故障排除指南

### 常见问题

1. **API配置丢失**
   ```bash
   # 症状：配置中心显示"未找到API配置"
   # 原因：数据库被清空或API配置表被删除
   # 解决：回滚到最近的稳定版本
   git reset --hard <stable_commit>
   git push --force origin main
   ```

2. **代理连接失败**
   ```bash
   # 症状：本地开发时API请求失败
   # 检查：线上服务器状态
   curl http://13.158.74.102:8000/health
   
   # 检查：代理端点
   curl http://13.158.74.102:8000/api/proxy/okx
   ```

3. **环境检测错误**
   ```bash
   # 手动设置环境变量
   export ENVIRONMENT=local
   python3 start_local.py
   ```

### 紧急恢复流程

1. **立即回滚**
   ```bash
   git log --oneline -10  # 查看最近提交
   git reset --hard <last_stable_commit>
   git push --force origin main
   ```

2. **服务检查**
   ```bash
   # 检查服务状态
   curl http://13.158.74.102:8000/health
   
   # 检查API配置
   curl http://13.158.74.102:8000/api/config/api
   ```

3. **数据恢复**
   - 从备份恢复数据库
   - 重新配置API密钥
   - 验证功能完整性

## 文件结构说明

```
OKX/
├── ARCHITECTURE_GUIDE.md          # 本文档
├── LOCAL_DEVELOPMENT.md           # 本地开发指南
├── README.md                      # 项目说明
├── requirements.txt               # Python依赖
├── .gitignore                     # Git忽略规则
├── backend/                       # 后端代码
│   ├── main.py                   # 主服务文件（核心，谨慎修改）
│   ├── okx_api.py               # OKX直连客户端
│   ├── proxy_api.py             # OKX代理客户端
│   ├── start_local.py           # 本地开发启动脚本
│   ├── models.py                # 数据模型
│   └── .env.example             # 环境变量示例
└── frontend/                     # 前端代码
    ├── src/
    │   ├── api.js               # API配置（注意服务器地址）
    │   ├── App.vue              # 主应用组件
    │   ├── main.js              # 入口文件
    │   ├── components/          # 可复用组件
    │   └── views/               # 页面组件
    ├── package.json             # 前端依赖
    └── vite.config.js           # 构建配置
```

## 重要提醒

### 对开发者的提醒

1. **理解架构再动手**
   - 修改代码前必须完全理解现有架构
   - 不确定时先询问或查看文档
   - 大规模修改前先在分支中测试

2. **保护线上环境**
   - 线上服务器是生产环境，必须保持稳定
   - 任何可能影响稳定性的修改都要谨慎
   - 出现问题立即回滚，不要尝试在线修复

3. **遵循开发流程**
   - 本地开发 → 测试验证 → 代码提交 → 生产部署
   - 不要跳过任何环节
   - 保持代码和文档同步更新

### 架构设计理念

1. **安全第一**
   - OKX API密钥只存储在线上服务器
   - 本地开发通过代理访问，不直接接触敏感信息
   - IP白名单机制确保API访问安全

2. **开发友好**
   - 本地开发体验与生产环境一致
   - 自动环境检测，无需手动配置
   - 热重载支持，提高开发效率

3. **部署简单**
   - 代码在本地和生产环境无差异
   - 环境自动适配，无需修改配置
   - 一键部署，减少人为错误

## 版本历史

- **v1.0** - 初始架构设计，实现基本功能
- **v1.1** - 添加代理转发机制，支持本地开发
- **v1.2** - 完善环境检测，优化开发体验
- **v1.3** - 添加总资产显示功能
- **v1.4** - 代码重构与架构文档完善

---

**最后更新**: 2025年8月16日
**维护者**: CodeBuddy
**文档版本**: v1.0

> ⚠️ **重要提醒**: 本文档是系统架构的核心指南，任何架构相关的修改都应该先更新此文档，确保团队成员了解变更内容。